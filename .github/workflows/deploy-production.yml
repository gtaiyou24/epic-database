name: "ğŸš€ Deploy: Production"
run-name: ğŸ“Œ  <${{ inputs.deploy_to }}> æœ¬ç•ªç’°å¢ƒã¸ ${{ github.ref_name }} ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ ğŸš€

on:
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:
    inputs:
      deploy_to:
        type: choice
        description: Deploy to
        default: all
        options:
          - all
          - web
          - subscriber
          - batch
      approval:
        description: 'type deploy/production'
        required: true

# æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åŒæ™‚ã«å®Ÿè¡Œã§ããªã„ã‚ˆã†ã«ã‚³ãƒ³ã‚«ãƒ¬ãƒ³ã‚·ãƒ¼ã‚’ä½¿ç”¨
concurrency: ${{ github.workflow }}

jobs:
  check-input:
    runs-on: ubuntu-latest
    name: 'ğŸ‘€ ãƒªãƒªãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯'
    steps:
      - if: ${{ github.event.inputs.approval != 'deploy/production' }}
        run: echo '::error ::`approval` ã« `deploy/production` ã¨å…¥åŠ›ã—ã¦ãã ã•ã„'; exit 1
      - if: ${{ github.ref_name != 'main' }}
        run: echo '::error ::`branch` ã¯ `main` ã‚’æŒ‡å®šã—ã¦ãã ã•ã„'; exit 1

  test:
    needs: check-input
    name: 'âœ… ãƒ†ã‚¹ãƒˆ'
    uses: ./.github/workflows/_python-test.yml
    with:
      python-version: '3.12'

  deploy-web:
    if: ${{ (github.event.inputs.deploy_to == 'all') || (github.event.inputs.deploy_to == 'web') }}
    needs: test
    name: 'ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤'
    uses: ./.github/workflows/_deploy-web-application.yml
    with:
      project-id: "epic-database-439005"
      region: 'asia-northeast1'
      workload-identity-provider: 'projects/917173493008/locations/global/workloadIdentityPools/github-actions-oidc/providers/github-actions-oidc-provider'
      github-actions-service-account: 'github-actions@epic-database-439005.iam.gserviceaccount.com'
      cloud-run-name: 'web-application'
      cloud-run-service-account: 'web-application@epic-database-439005.iam.gserviceaccount.com'
      cloud-run-min-instances: 0
      cloud-run-backend-env-vars: "^@^SLF4PY_LOG_LEVEL=INFO@OPENAPI_PREFIX=@DI_PROFILE_ACTIVES=Stub@HOGE=greeting"
      cloud-run-secrets: ""
      cloud-sql-vpc-connector: "projects/epic-database-439005/locations/asia-northeast1/connectors/application-db-vpc-con"
#      cleanup-images: true

  deploy-subscriber:
    if: ${{ (github.event.inputs.deploy_to == 'all') || (github.event.inputs.deploy_to == 'subscriber') }}
    needs: test
    name: 'ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤'
    uses: ./.github/workflows/_deploy-subscriber.yml
    with:
      project-id: "epic-database-439005"
      region: 'asia-northeast1'
      workload-identity-provider: 'projects/917173493008/locations/global/workloadIdentityPools/github-actions-oidc/providers/github-actions-oidc-provider'
      github-actions-service-account: 'github-actions@epic-database-439005.iam.gserviceaccount.com'
      cloud-run-name: 'subscriber'
      cloud-run-service-account: 'subscriber@epic-database-439005.iam.gserviceaccount.com'
      cloud-run-min-instances: 0
      cloud-run-port: 8000
      cloud-run-env-vars: "^@^SLF4PY_LOG_LEVEL=INFO@OPENAPI_PREFIX=@DI_PROFILE_ACTIVES=InMem,Stub"
#      cloud-run-secrets: ""

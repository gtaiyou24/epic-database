name: "🚀 Deploy: Production"
run-name: 📌  <${{ inputs.deploy_to }}> 本番環境へ ${{ github.ref_name }} をデプロイ 🚀

on:
  # 手動トリガー
  workflow_dispatch:
    inputs:
      deploy_to:
        type: choice
        description: Deploy to
        default: all
        options:
          - all
          - api
          - batch
          - consumer
      approval:
        description: 'type deploy/production'
        required: true

# 本番リリースワークフローを同時に実行できないようにコンカレンシーを使用
concurrency: ${{ github.workflow }}

jobs:
  check-input:
    runs-on: ubuntu-latest
    name: '👀 リリースチェック'
    steps:
      - if: ${{ github.event.inputs.approval != 'deploy/production' }}
        run: echo '::error ::`approval` に `deploy/production` と入力してください'; exit 1
      - if: ${{ github.ref_name != 'main' }}
        run: echo '::error ::`branch` は `main` を指定してください'; exit 1

  test:
    needs: check-input
    name: '✅ テスト'
    uses: ./.github/workflows/test.yml
    with:
      python-version: '3.12'

  deploy-api:
    if: ${{ (github.event.inputs.deploy_to == 'all') || (github.event.inputs.deploy_to == 'api') }}
    needs: test
    name: '🚀 デプロイ'
    uses: ./.github/workflows/_deploy-to-cloud-run.yml
    with:
      project-id: 'epic-database-438905'
      workload-identity-provider: 'projects/425814525781/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
      service-account: 'github-actions@epic-database-438905.iam.gserviceaccount.com'
      registry: 'epic-database'
      cloud-run-name: 'epic-database'
      cloud-run-service-account: 'cloud-run-service-account@epic-database-438905.iam.gserviceaccount.com'
      cloud-run-min-instances: 0
      env-vars: "^@^SLF4PY_LOG_LEVEL=INFO@OPENAPI_PREFIX=@DI_PROFILE_ACTIVES=InMem,Stub"
      secrets: ""
      region: 'asia-northeast1'
      cleanup-images: true
